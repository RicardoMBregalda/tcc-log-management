openapi: 3.0.3
info:
  title: Sistema de Gerenciamento de Logs - API Híbrida
  description: |
    API REST para sistema de gerenciamento de logs com arquitetura híbrida utilizando MongoDB (off-chain) e Hyperledger Fabric (blockchain).
    
    ## Características
    - Write-Ahead Log (WAL) com garantia de 0% de perda de dados
    - Sincronização assíncrona com blockchain
    - Cache Redis otimizado
    - Merkle Tree para verificação de integridade
    - Connection pooling otimizado
    
    ## Otimizações Ativas
    - Sincronização assíncrona com Fabric (-80% latência)
    - Cache Redis com TTL 10-15 minutos
    - Índices MongoDB compostos
    - Connection Pool 10-100 conexões
    - Auto-Batching Merkle Tree a cada 30 segundos
  version: 1.0.0
  contact:
    name: TCC Log Management
servers:
  - url: http://localhost:5001
    description: Servidor de desenvolvimento

tags:
  - name: Health
    description: Endpoints de verificação de saúde do sistema
  - name: Logs
    description: Operações de criação e consulta de logs
  - name: Merkle Tree
    description: Operações de batching e verificação de integridade
  - name: WAL
    description: Operações do Write-Ahead Log
  - name: Statistics
    description: Estatísticas e métricas do sistema

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Verifica o status de saúde do sistema incluindo status do WAL e otimizações ativas
      responses:
        '200':
          description: Sistema operacional
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  database:
                    type: string
                    example: mongodb
                  blockchain:
                    type: string
                    example: fabric
                  wal:
                    type: object
                    properties:
                      enabled:
                        type: boolean
                      pending_count:
                        type: integer
                      total_written:
                        type: integer
                      total_processed:
                        type: integer
                      processor_running:
                        type: boolean
                      guarantee:
                        type: string
                        example: 0% data loss
                  optimizations:
                    type: object
                    properties:
                      async_fabric_sync:
                        type: boolean
                      redis_cache_optimized:
                        type: boolean
                      mongodb_compound_indexes:
                        type: boolean
                      connection_pool_size:
                        type: string
                        example: 10-100
                      write_ahead_log:
                        type: boolean

  /logs:
    post:
      tags:
        - Logs
      summary: Criar novo log
      description: |
        Cria um novo log com garantia de durabilidade através do Write-Ahead Log (WAL).
        
        ## Fluxo
        1. Escreve no WAL (garantia de durabilidade em disco)
        2. Tenta inserir no MongoDB imediatamente
        3. Se MongoDB falhar, WAL reprocessa automaticamente
        4. Agenda sincronização com Fabric em background
        5. Retorna imediatamente com garantia de 0% de perda
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LogInput'
            examples:
              info_log:
                summary: Log de informação
                value:
                  source: app-server
                  level: INFO
                  message: Application started successfully
                  metadata:
                    version: 1.0.0
                    environment: production
              error_log:
                summary: Log de erro com stacktrace
                value:
                  source: api-gateway
                  level: ERROR
                  message: Database connection failed
                  stacktrace: "Traceback (most recent call last):\n  File \"app.py\", line 42..."
                  metadata:
                    retry_count: 3
                    timeout: 30
      responses:
        '201':
          description: Log criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogCreateResponse'
        '400':
          description: Campos obrigatórios ausentes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    get:
      tags:
        - Logs
      summary: Listar logs
      description: |
        Lista logs com filtros opcionais e cache inteligente.
        
        ## Otimizações
        - Cache Redis com TTL de 10 minutos
        - Índices compostos para queries rápidas
        - Projeção otimizada
      parameters:
        - name: source
          in: query
          description: Filtrar por fonte do log
          schema:
            type: string
          example: app-server
        - name: level
          in: query
          description: Filtrar por nível de log
          schema:
            type: string
            enum: [DEBUG, INFO, WARNING, ERROR, CRITICAL]
          example: ERROR
        - name: limit
          in: query
          description: Número máximo de logs a retornar
          schema:
            type: integer
            default: 100
            minimum: 1
            maximum: 1000
          example: 50
        - name: offset
          in: query
          description: Número de logs a pular (paginação)
          schema:
            type: integer
            default: 0
            minimum: 0
          example: 0
      responses:
        '200':
          description: Lista de logs
          content:
            application/json:
              schema:
                type: object
                properties:
                  logs:
                    type: array
                    items:
                      $ref: '#/components/schemas/Log'
                  cached:
                    type: boolean
                    description: Indica se o resultado veio do cache
                  count:
                    type: integer
                    description: Número de logs retornados
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /logs/{log_id}:
    get:
      tags:
        - Logs
      summary: Buscar log específico
      description: |
        Busca log por ID com cache de 15 minutos.
        Retorna também o status de sincronização com Fabric.
      parameters:
        - name: log_id
          in: path
          required: true
          description: ID único do log
          schema:
            type: string
          example: app-server_1a2b3c4d5e6f7890
      responses:
        '200':
          description: Log encontrado
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/Log'
                  - type: object
                    properties:
                      fabric_sync:
                        $ref: '#/components/schemas/SyncStatus'
        '404':
          description: Log não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /merkle/batch:
    post:
      tags:
        - Merkle Tree
      summary: Criar batch com Merkle Tree
      description: |
        Cria um batch de logs com Merkle Root e armazena no blockchain.
        
        ## Processo
        1. Busca logs sem batch_id
        2. Calcula Merkle Root
        3. Armazena batch no Fabric
        4. Atualiza logs no MongoDB com batch_id
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                batch_size:
                  type: integer
                  default: 100
                  minimum: 1
                  maximum: 1000
                  description: Número de logs a incluir no batch
            examples:
              default:
                summary: Batch padrão
                value:
                  batch_size: 100
              large:
                summary: Batch grande
                value:
                  batch_size: 500
      responses:
        '201':
          description: Batch criado com sucesso
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MerkleBatchResponse'
        '200':
          description: Nenhum log disponível para batching
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: No logs available for batching
        '500':
          description: Erro ao criar batch
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /merkle/batch/{batch_id}:
    get:
      tags:
        - Merkle Tree
      summary: Consultar batch
      description: Retorna informações de um batch incluindo Merkle Root e lista de logs
      parameters:
        - name: batch_id
          in: path
          required: true
          description: ID único do batch
          schema:
            type: string
          example: batch_20241223_143025_123456
      responses:
        '200':
          description: Batch encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  batch:
                    $ref: '#/components/schemas/MerkleBatch'
                  logs:
                    type: array
                    items:
                      $ref: '#/components/schemas/Log'
                  num_logs:
                    type: integer
        '404':
          description: Batch não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /merkle/verify/{batch_id}:
    post:
      tags:
        - Merkle Tree
      summary: Verificar integridade do batch
      description: |
        Verifica a integridade de um batch recalculando o Merkle Root e comparando com o valor armazenado no blockchain.
        
        ## Validação
        1. Busca logs do batch no MongoDB (ordem original)
        2. Recalcula Merkle Root
        3. Busca Merkle Root do blockchain
        4. Compara os valores
      parameters:
        - name: batch_id
          in: path
          required: true
          description: ID único do batch
          schema:
            type: string
          example: batch_20241223_143025_123456
      responses:
        '200':
          description: Verificação concluída
          content:
            application/json:
              schema:
                type: object
                properties:
                  batch_id:
                    type: string
                  valid:
                    type: boolean
                    description: Indica se o batch está íntegro
                  calculated_root:
                    type: string
                    description: Merkle Root calculado
                  stored_root:
                    type: string
                    description: Merkle Root armazenado no blockchain
                  num_logs:
                    type: integer
                  message:
                    type: string
        '404':
          description: Batch não encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /merkle/batches:
    get:
      tags:
        - Merkle Tree
      summary: Listar batches
      description: Lista todos os batches criados com paginação
      parameters:
        - name: limit
          in: query
          description: Número máximo de batches a retornar
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 500
        - name: offset
          in: query
          description: Número de batches a pular (paginação)
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: Lista de batches
          content:
            application/json:
              schema:
                type: object
                properties:
                  batches:
                    type: array
                    items:
                      type: object
                      properties:
                        batch_id:
                          type: string
                        num_logs:
                          type: integer
                        created_at:
                          type: string
                          format: date-time
                  count:
                    type: integer
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /wal/stats:
    get:
      tags:
        - WAL
      summary: Estatísticas do WAL
      description: |
        Retorna estatísticas do Write-Ahead Log incluindo contadores e status do processor.
        Útil para monitoramento e debugging.
      responses:
        '200':
          description: Estatísticas do WAL
          content:
            application/json:
              schema:
                type: object
                properties:
                  wal_statistics:
                    type: object
                    properties:
                      pending_count:
                        type: integer
                        description: Número de logs pendentes de processamento
                      total_written:
                        type: integer
                        description: Total de logs escritos no WAL
                      total_processed:
                        type: integer
                        description: Total de logs processados com sucesso
                      processor_running:
                        type: boolean
                        description: Status do processor em background
                  status:
                    type: string
                    enum: [healthy, processor_stopped]
                  data_loss_guarantee:
                    type: string
                    example: 0%

  /wal/force-process:
    post:
      tags:
        - WAL
      summary: Forçar processamento do WAL
      description: |
        Força processamento imediato de logs pendentes no WAL.
        Útil para testes e recovery manual.
      responses:
        '200':
          description: Processamento forçado concluído
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: success
                  message:
                    type: string
                    example: Forced WAL processing completed
                  pending_count:
                    type: integer
                  total_processed:
                    type: integer
        '500':
          description: Erro ao processar WAL
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /stats:
    get:
      tags:
        - Statistics
      summary: Estatísticas do sistema
      description: Retorna estatísticas gerais incluindo total de logs e status de sincronização
      responses:
        '200':
          description: Estatísticas do sistema
          content:
            application/json:
              schema:
                type: object
                properties:
                  total_logs:
                    type: integer
                    description: Número total de logs no sistema
                  fabric_sync_status:
                    type: object
                    description: Contadores por status de sincronização
                    additionalProperties:
                      type: integer
                    example:
                      pending: 150
                      synced: 8500
                      failed: 5
                  optimizations_active:
                    type: boolean
        '500':
          description: Erro interno do servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  schemas:
    LogInput:
      type: object
      required:
        - source
        - level
        - message
      properties:
        id:
          type: string
          description: ID personalizado (opcional, gerado automaticamente se omitido)
          example: custom-log-id-12345
        source:
          type: string
          description: Fonte geradora do log
          example: app-server
        level:
          type: string
          enum: [DEBUG, INFO, WARNING, ERROR, CRITICAL]
          description: Nível de severidade do log
          example: INFO
        message:
          type: string
          description: Mensagem do log
          example: Application started successfully
        timestamp:
          type: string
          format: date-time
          description: Timestamp do log (opcional, gerado automaticamente se omitido)
          example: 2024-01-23T14:30:25Z
        metadata:
          type: object
          description: Metadados adicionais (opcional)
          additionalProperties: true
          example:
            version: 1.0.0
            environment: production
        stacktrace:
          type: string
          description: Stack trace em caso de erro (opcional)
          example: "Traceback (most recent call last):\n  File \"app.py\", line 42..."

    Log:
      type: object
      properties:
        id:
          type: string
          example: app-server_1a2b3c4d5e6f7890
        hash:
          type: string
          description: Hash SHA256 do conteúdo do log
          example: a3f5b8c1d2e4f6a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2
        timestamp:
          type: string
          format: date-time
          example: 2024-01-23T14:30:25Z
        source:
          type: string
          example: app-server
        level:
          type: string
          example: INFO
        message:
          type: string
          example: Application started successfully
        metadata:
          type: object
          additionalProperties: true
        stacktrace:
          type: string
        created_at:
          type: string
          format: date-time
          example: 2024-01-23T14:30:25.123456
        batch_id:
          type: string
          description: ID do batch Merkle Tree (se aplicável)
          example: batch_20241223_143025_123456
        merkle_root:
          type: string
          description: Merkle Root do batch (se aplicável)
          example: b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3
        batched_at:
          type: string
          format: date-time
          description: Timestamp de quando foi incluído no batch

    LogCreateResponse:
      type: object
      properties:
        id:
          type: string
          example: app-server_1a2b3c4d5e6f7890
        hash:
          type: string
          example: a3f5b8c1d2e4f6a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2
        status:
          type: string
          example: success
        mongodb_status:
          type: string
          enum: [inserted, duplicate_ignored, pending_in_wal]
          description: Status da inserção no MongoDB
        fabric_sync:
          type: string
          enum: [pending, synced, failed]
          description: Status da sincronização com Fabric
        durability:
          type: string
          example: GUARANTEED_BY_WAL
        message:
          type: string
          example: Log persisted to WAL with 0% loss guarantee

    SyncStatus:
      type: object
      properties:
        log_id:
          type: string
        sync_status:
          type: string
          enum: [pending, pending_batch, synced, failed]
        batch_id:
          type: string
        created_at:
          type: string
          format: date-time
        synced_at:
          type: string
          format: date-time

    MerkleBatch:
      type: object
      properties:
        batch_id:
          type: string
          example: batch_20241223_143025_123456
        merkle_root:
          type: string
          example: b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3
        timestamp:
          type: string
          format: date-time
          example: 2024-01-23T14:30:25Z
        num_logs:
          type: integer
          example: 100
        log_ids:
          type: array
          items:
            type: string

    MerkleBatchResponse:
      type: object
      properties:
        batch_id:
          type: string
          example: batch_20241223_143025_123456
        merkle_root:
          type: string
          example: b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c3
        num_logs:
          type: integer
          example: 100
        log_ids:
          type: array
          items:
            type: string
        status:
          type: string
          example: success
        message:
          type: string
          example: Merkle batch created and stored in blockchain

    Error:
      type: object
      properties:
        error:
          type: string
          example: Missing required fields
